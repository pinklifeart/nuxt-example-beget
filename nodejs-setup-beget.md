# Настройка Node.js

В статье будет рассмотрена установка Node.JS, а также разворачивание тестового проекта на одном из фреймворков.

> Обратите внимание!
Если вы хотите запустить веб-приложение, но еще не создали сайт - сначала необходимо создать сайт и прикрепить к нему домен в разделе Сайты. Лучше всего имя сайта указывать аналогично желаемому доменному имени - в противном случае в будущем могут возникнуть трудности с пониманием файловой структуры.
Если у вас еще нет доменного имени, его можно добавить или зарегистрировать в разделе Домены.
После того, как сайт создан и к нему прикреплён домен, направленный на наши NS сервера, можно приступать к настройке.

Сначала необходимо подключиться к аккаунту по протоколу SSH.

## Подключение к аккаунту

Если Вы пользуетесь OS Windows, то, скорее всего, Вам подойдет SSH-клиент PuTTy (статью по настройке можно прочитать здесь). Когда настроите, можно переходить на шаг 2. Если вы используете Windows 10 и выше, вы также можете воспользоваться PowerShell.

Если Вы пользуетесь OS Linux или OS X, подойдет обычный терминал, который присутствует во всех Unix-подобных операционных системах. Подключиться можно следующей командой:
```
ssh username@username.beget.tech
```
Где username - логин, username.beget.tech - адрес сервера (посмотреть его можно в блоке Техническая информация на главной странице панели управления).

Также Вы можете воспользоваться терминалом в панели управления.

## Переход в Docker

Далее нужно перейти в виртуальное окружении Docker. Запуск Node.js осуществляется **только внутри Docker контейнера**. Для этого, после подключения по SSH необходимо ввести команду:
```
ssh localhost -p 222
```
После чего ввести свой пароль для подключения к SSH. В строке терминала будет отображено, что теперь мы находимся в Docker окружении:
```
(docker) username@server: [0]~
```
На некоторых серверах хостинга по умолчанию установлены Node.js и npm старых версий:
```
(docker) valkeru@oscar2:~ [0] $ node -v
v8.12.0
(docker) valkeru@oscar2:~ [0] $ npm -v
6.4.1
```
Однако на некоторых серверах они могут отсутствовать:
```
-bash: node: command not found
```
Для использования актуальных версий Node.js и npm потребуется установить их.

## Установка актуальной версии Node.js из официальных источников

> Обратите внимание!
Для виртуального хостинга максимальной на данный момент версией, доступной для установки с официального сайта nodejs.org является 17.9.1. NodeJS версии 18.0 и выше работать не будет.
Учитывайте эту информацию при выборе версии.

Установка Node.js производится в каталог **.local** Вашей учётной записи, если данной директории в корне вашего аккаунта нет, её потребуется создать командой `mkdir`:
```
mkdir -p .local
```
После чего перейдем в каталог:
```
cd .local
```
> Обратите внимание!
Загружать нужно 64-разрядную версию, запуск исполняемых файлов для 32-битной архитектуры на наших серверах запрещён!

Загрузим дистрибутив командой wget(в примере указана ссылка на архив с версией 17.9.1, если вам необходима другая версия, вы можете найти нужный вам архив по ссылке https://nodejs.org/dist/):
```
wget https://nodejs.org/dist/v17.9.1/node-v17.9.1-linux-x64.tar.xz

--2023-08-03 20:28:33--  https://nodejs.org/dist/v17.9.1/node-v17.9.1-linux-x64.tar.xz
Resolving nodejs.org (nodejs.org)... 104.20.22.46, 104.20.23.46, 2606:4700:10::6814:172e, ...
Connecting to nodejs.org (nodejs.org)|104.20.22.46|:443... connected.
HTTP request sent, awaiting response... 200 OK
Length: 22672072 (22M) [application/x-xz]
Saving to: ‘node-v17.9.1-linux-x64.tar.xz’

node-v17.9.1-linux-x64.tar.xz              100%[======================================================================================>]  21.62M  9.73MB/s    in 2.2s

2023-08-03 20:28:36 (9.73 MB/s) - ‘node-v17.9.1-linux-x64.tar.xz’ saved [22672072/22672072]
```
После того, как архив успешно загрузился, распакуем его:
```
tar -xJf node-v17.9.1-linux-x64.tar.xz --strip 1
```
> Обратите внимание!
>  Ключ `--strip 1` в данном случае необходим для распаковки архива непосредственно в директорию `.local`. Если вы не планируете использовать несколько различных версий Node.js, рекомендуем использовать его при установке, в противном случае архив распакуется в директорию вида `node-v17.9.1-linux-x64`.

Проверим работу node и npm:
```
node -v && npm -v
```
Пример корректного результата:
```
(docker) pinklife@dalek:~ [0] $ node -v && npm -v
v17.9.1
8.11.0
```
Если после запуска команды отображается версия Node, соответствующая загруженному архиву, установка выполнена успешно и ошибок при вызове не возникает, можем удалить архив дистрибутива(если вы устанавливали версию, отличную от 17.9.1, укажите соответствующее название файла в команде):
```
rm node-v17.9.1-linux-x64.tar.xz
```
> Обратите внимание!
> Поскольку сайты на учётных записях изолированы, для запуска Node.js из окружения веб-сервера потребуется открыть общий доступ к каталогу ~/.local.
> Инструкция по предоставлению общего доступа приведена в этой статье.

## Установка Node.js версии 18.x и выше

В связи с особенностями окружения виртуального хостинга, официальные исполняемые файлы Node.js версий 18.x и выше не могут быть запущены на всех серверах хостинга. Для решения данной проблемы нами были собраны исполняемые файлы для некоторых версий из исходного кода с nodejs.org, совместимые с окружением хостинга.

> Внимание!
> Если для вашего проекта не критично использование версии выше 17.9.1, рекомендуем использовать её. Исполняемые файлы новых версий предоставляются "как есть". Мы не несем ответственность за возможные сбои, вызванные использованием предоставляемых исполняемых файлов.

Для установки на данный момент доступны версии `18.17.0`, `19.9.0` и `20.5.0`. Ссылки на архивы:
- **18.17.0**: https://cp.beget.com/shared/nZ-Grt-wdN-TpDRnWM0Fg3XkTf_NScI2/node-v18.17.0-bionic.tar.xz
- **19.9.0**: https://cp.beget.com/shared/wHV_h4FJaIvwzqchZJuyRPalU58o5xmP/node-v19.9.0-bionic.tar.xz
- **20.5.0**: https://cp.beget.com/shared/H1crojipLBTHZbxHTvYA-ro_JXppCrB-/node-v20.5.0-bionic.tar.xz

Сам процесс установки не отличается от установки из официального источника. Находясь в корне аккаунта, создадим каталог .local, если его еще нет:
```
mkdir -p .local
```
И перейдем в него:
```
cd .local
```
Загрузим архив с дистрибутивом, используя одну из указанных выше ссылок(в данном примере рассматривается установка версии 20.5.0):
```
wget "https://cp.beget.com/shared/H1crojipLBTHZbxHTvYA-ro_JXppCrB-/node-v20.5.0-bionic.tar.xz"
```
Распакуем архив в директорию .local:
```
tar -xJf node-v20.5.0-bionic.tar.xz --strip 1
```
> Обратите внимание!
>  Ключ `--strip 1` в данном случае необходим для распаковки архива непосредственно в директорию `.local`. Если вы не планируете использовать несколько различных версий Node.js, рекомендуем использовать его при установке, в противном случае архив распакуется в директорию вида `node-v20.5.0-bionic`.

Проверим работу node и npm:
```
node -v && npm -v
```
Пример корректного результата выполнения команд:
```
(docker) pinklife@dalek:~ [0] $ node -v && npm -v
v20.5.0
9.8.0
```

Если после запуска команды отображается версия Node, соответствующая загруженному архиву и ошибок при вызове не возникает, установка выполнена успешно, можем удалить архив дистрибутива(если вы устанавливали версию, отличную от 20.5.0, укажите соответствующее название файла в команде):
```
rm node-v20.5.0-bionic.tar.xz
```
> Обратите внимание!
> Поскольку сайты на учётных записях изолированы, для запуска Node.js из окружения веб-сервера потребуется открыть общий доступ к каталогу ~/.local.
> Инструкция по предоставлению общего доступа приведена в этой статье.

## Разворачивание Node-приложения на виртуальном хостинге

На виртуальном хостинге Node-приложения запускаются с помощью Apache mod_passenger. Сам процесс может отличаться в зависимости от используемого фреймворка и структуры вашего проекта, однако в общих чертах сводится к следующим этапам:
1. Создание каталога проекта и размещение файлов проекта
2. Установка требуемых зависимостей
3. Сборка проекта
4. Создание символьных ссылок при необходимости
5. Создание файла **.htaccess** для конфигурации и запуска проекта с помощью mod_passenger
6. Создание директории `tmp` и файла `restart.txt` в директории, указанной как PassengerAppRoot в .htaccess ранее

В качестве примера развернем тестовое приложение на `Nuxt.js`: https://github.com/pinklifeart/nuxt-example-beget.git
1. Если сайт под проект еще не создан в разделе Сайты, создаем его.
2. Переходим в каталог проекта
```
cd ~/nuxt.pinklife.beget.tech
```
3. Клонируем репозиторий
```
git clone https://github.com/pinklifeart/nuxt-example-beget.git
```
> Примечание.
> В данном случае создание директории проекта и размещение его файлов в ней происходит путем клонирования репозитория с GitHub. Для вашего проекта может понадобиться создать каталог вручную и поместить файлы в него.
4. Создаем файл .htaccess, в котором задаем конфигурацию проекта:
```
PassengerNodejs /home/p/pinklife/.local/bin/node
PassengerAppRoot /home/p/pinklife/nuxt.pinklife.beget.tech/nuxt-example-beget
PassengerAppType node
PassengerStartupFile server.js
```
- **PassengerNodejs** - путь до исполняемого файла Node.js, узнать путь можно, выполнив команду `which node`
- **PassengerAppRoot** - путь до директории проекта
- **PassengerAppType** - тип приложения, в данном случае node
- **PassengerStartupFile** - точка входа в приложение, будет отличаться в зависимости от структуры проекта и используемого фреймворка
5. Удаляем директорию **public_html** и создаем символьную ссылку на директорию со статическими файлами для того, чтобы они отдавались средствами Nginx:
```
rm -rf public_html
ln -s nuxt-example-beget/public public_html
```
> Примечание
> В данном случае можно использовать и обратный метод - разместить статический контент в public_html и добавить в директории проекта ссылки на нее. Убедитесь, что конечная директория не имеет FTP-аккаунтов, прикрепленных к ней, в противном случае может возникнуть ошибка доступа к статическому контенту.
6. Переходим в директорию проекта, устанавливаем зависимости и собираем проект:
```
cd nuxt-example-beget
npm install
npm run build
```
> Примечание
> Команды могут отличаться, если вами используется другой менеджер пакетов, например, Yarn или pnpm.
7. Создаем в директории проекта каталог `tmp` и файл `restart.txt` в нем:
```
mkdir tmp
touch tmp/restart.txt
```
Проверим результат, открыв наш проект в браузере:

![](https://cp.beget.com/shared/U_-BSxeA4xHKJPACh5qG_Pz3LOuxdYb-/nuxt_example.webp)